<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Ops Command Center — Tower Load Forecast → CNPS Impact</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Plotly + PapaParse (CSV) -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1020;
      --card:#0E1730;
      --card2:#0B1328;
      --text:#EAF0FF;
      --muted:#A8B3D6;
      --muted2:#7F8BB8;
      --border:rgba(255,255,255,.08);
      --accent:#7C5CFF;
      --accent2:#2FE3C0;
      --warn:#FFB020;
      --bad:#FF4D6D;
      --good:#2FE3C0;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 12% 12%, rgba(124,92,255,.22), transparent 55%),
        radial-gradient(900px 600px at 88% 18%, rgba(47,227,192,.16), transparent 55%),
        radial-gradient(900px 650px at 50% 95%, rgba(255,77,109,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:1220px;margin:0 auto;padding:28px 18px 60px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:14px 16px;border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius:var(--radius);box-shadow:var(--shadow);
      position:sticky;top:16px;backdrop-filter: blur(10px); z-index:50;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: conic-gradient(from 210deg, var(--accent), #3AB8FF, var(--accent2), var(--accent));
      box-shadow: 0 10px 26px rgba(124,92,255,.28);
    }
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{font-size:14px;margin:0;font-weight:800;letter-spacing:.2px}
    .title p{font-size:12px;margin:0;color:var(--muted)}
    .nav{
      display:flex;gap:8px;flex-wrap:nowrap;justify-content:flex-end;overflow:auto;
    }
    .tab{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      padding:10px 12px;border-radius:14px;
      font-size:12px;font-weight:700;letter-spacing:.2px;
      cursor:pointer; user-select:none;
      transition: transform .12s ease, background .12s ease, color .12s ease;
      white-space:nowrap;
    }
    .tab:hover{transform:translateY(-1px);background:rgba(255,255,255,.06);color:var(--text)}
    .tab.active{
      background:linear-gradient(180deg, rgba(124,92,255,.22), rgba(124,92,255,.10));
      border-color:rgba(124,92,255,.38);
      color:var(--text);
    }

    .hero{
      margin-top:18px;
      padding:22px 18px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      display:grid;
      grid-template-columns: 1.4fr .9fr;
      gap:16px;
    }
    @media (max-width: 980px){ .hero{grid-template-columns:1fr} }
    .hero h2{margin:0;font-size:22px;font-weight:900;letter-spacing:-.4px}
    .hero p{margin:8px 0 0;color:var(--muted);line-height:1.5}
    .pillrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .pill{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:10px 12px;border-radius:999px;
      font-size:12px;font-weight:800;color:var(--text);
      display:flex;gap:8px;align-items:center;
    }
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.a{background:var(--accent)}
    .dot.b{background:var(--accent2)}
    .dot.c{background:var(--warn)}
    .callout{
      border:1px solid rgba(47,227,192,.25);
      background:linear-gradient(180deg, rgba(47,227,192,.12), rgba(255,255,255,.02));
      border-radius:var(--radius2);
      padding:14px;
    }
    .callout h3{margin:0 0 6px;font-size:13px;font-weight:900}
    .callout p{margin:0;color:var(--muted);font-size:12px;line-height:1.45}

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
    }
    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      min-height:120px;
    }
    .card h3{margin:0 0 10px;font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.25px;text-transform:uppercase}
    .kpi{
      display:flex;align-items:baseline;justify-content:space-between;gap:12px;
      padding:6px 4px 2px;
    }
    .kpi .value{font-size:26px;font-weight:900;letter-spacing:-.6px}
    .kpi .sub{font-size:12px;color:var(--muted)}
    .kpi .delta{
      font-size:12px;font-weight:900;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      white-space:nowrap;
    }
    .delta.good{color:var(--good);border-color:rgba(47,227,192,.25);background:rgba(47,227,192,.08)}
    .delta.bad{color:var(--bad);border-color:rgba(255,77,109,.25);background:rgba(255,77,109,.08)}
    .delta.warn{color:var(--warn);border-color:rgba(255,176,32,.25);background:rgba(255,176,32,.08)}

    .controls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      padding:10px 12px;border:1px solid var(--border);
      border-radius:16px;background:rgba(255,255,255,.03);
    }
    label{font-size:12px;color:var(--muted);font-weight:800}
    select, input[type="range"]{
      background:rgba(255,255,255,.05);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 10px;
      font-weight:700;
      outline:none;
    }
    select{min-width:180px}
    .rangeWrap{display:flex;flex-direction:column;gap:6px;min-width:260px}
    .rangeMeta{display:flex;justify-content:space-between;font-size:12px;color:var(--muted)}
    .section{display:none}
    .section.active{display:block}

    .chart{height:320px}
    .chartTall{height:420px}
    .split{
      display:grid;grid-template-columns: 1fr 1fr;gap:14px;
    }
    @media(max-width: 980px){.split{grid-template-columns:1fr}}

    .table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--border);
    }
    .table th, .table td{
      padding:10px 10px;
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      color:var(--muted);
    }
    .table th{
      color:var(--text);
      text-align:left;
      background:rgba(255,255,255,.05);
      font-weight:900;
      letter-spacing:.2px;
    }
    .badge{
      font-size:11px;font-weight:900;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      display:inline-flex;gap:8px;align-items:center;color:var(--text)
    }
    .badge .miniDot{width:8px;height:8px;border-radius:50%}
    .miniDot.good{background:var(--good)}
    .miniDot.bad{background:var(--bad)}
    .miniDot.warn{background:var(--warn)}
    .miniDot.neutral{background:var(--muted2)}

    .footer{
      margin-top:18px;
      color:var(--muted2);
      font-size:12px;
      line-height:1.5;
      padding:14px 4px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}

    /* Responsive tweaks per spec */
    @media (max-width: 820px) {
      .grid{grid-template-columns: repeat(1,1fr) !important;}
      .card{min-height:100px}
      .chart{height:260px}
      .chartTall{height:340px}
      .rangeWrap{min-width:unset}
      select{min-width:unset}
      .controls{flex-direction:column;align-items:stretch}
    }
    @media (max-width: 640px) {
      .topbar{padding:10px}
      .title h1{font-size:13px}
      .nav{gap:6px}
      .controls{padding:8px}
      .tab{padding:8px 10px;font-size:11px}
      .chart{height:240px}
      .chartTall{height:300px}
      select,input[type="range"]{width:100%}
    }
    @media (max-width:360px){
      body{font-size:13px}
      .wrap{padding:18px 10px 40px}
    }

    .csvNote{
      margin-left:8px;color:var(--warn);font-size:12px;font-weight:800;
      background:rgba(255,176,32,.06);padding:8px 10px;border-radius:10px;border:1px solid rgba(255,176,32,.12);
      display:none;
    }

    .calloutsInline{display:flex;gap:8px;flex-wrap:wrap}
    .calloutBadge{
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(255,255,255,.02);font-weight:800;font-size:12px;color:var(--text)
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>AI Ops Command Center</h1>
        <p>Forecast tower load → reduce detractor risk → improve CNPS (demo)</p>
      </div>
    </div>

    <div class="nav" id="tabsNav">
      <div class="tab active" data-tab="overview">Overview</div>
      <div class="tab" data-tab="operations">Operations</div>
      <div class="tab" data-tab="ai">AI Workflow</div>
      <div class="tab" data-tab="about">About</div>
    </div>
  </div>

  <div class="hero">
    <div>
      <h2>Run operations at scale with proactive AI: from tickets → capacity signals → experience outcomes.</h2>
      <p>
        This GitHub Page is a product-style demo dashboard powered by <span class="mono">precomputed ML outputs</span>.
        Model training happens locally (Python), then sanitized aggregates are exported to CSV and visualized here.
      </p>
      <div class="pillrow">
        <div class="pill"><span class="dot a"></span>North Star: CNPS uplift & detractor risk reduction</div>
        <div class="pill"><span class="dot b"></span>Tower Load Index (TLI) forecast for capacity planning</div>
        <div class="pill"><span class="dot c"></span>Action: prioritize high-risk work before CX degrades</div>
      </div>
    </div>
    <div class="callout">
      <h3>What’s inside</h3>
      <p>Interactive tower drilldowns, TLI trend + forecast, CNPS score and detractor risk, plus a narrative that explains how AI connects operational excellence to customer outcomes.</p>
      <p style="margin-top:8px">Data is sanitized: identifiers removed, dates reduced to month, and “Days Open” bucketized.</p>
    </div>
  </div>

  <!-- OVERVIEW -->
  <section id="overview" class="section active">
    <div class="grid">
      <div class="card" style="grid-column: span 12;">
        <div class="controls">
          <div>
            <label for="towerSelect">Tower</label><br/>
            <select id="towerSelect"></select>
          </div>

          <div class="rangeWrap">
            <label for="scenarioSlider">Scenario: reduce aging backlog (proxy for process improvement)</label>
            <input id="scenarioSlider" type="range" min="0" max="40" value="0" step="5" />
            <div class="rangeMeta">
              <span>0% change</span>
              <span id="scenarioLabel">0% reduction</span>
            </div>
          </div>

          <div>
            <label for="dataSourceSelect">Data source</label><br/>
            <select id="dataSourceSelect" title="Choose data source">
              <option value="embedded" selected>Embedded demo (default)</option>
              <option value="csv">CSV outputs (if available)</option>
            </select>
          </div>

          <div>
            <span class="badge"><span class="miniDot neutral"></span>Demo mode</span>
          </div>

          <div id="csvNote" class="csvNote" role="status" aria-live="polite">CSV missing/invalid — reverted to Embedded demo.</div>
        </div>
      </div>

      <div class="card" style="grid-column: span 4;">
        <h3>North Star: CNPS score</h3>
        <div class="kpi">
          <div>
            <div class="value" id="kpiCnps">—</div>
            <div class="sub">Latest month (tower)</div>
          </div>
          <div class="delta" id="kpiCnpsDelta">—</div>
        </div>
      </div>

      <div class="card" style="grid-column: span 4;">
        <h3>Detractor risk</h3>
        <div class="kpi">
          <div>
            <div class="value" id="kpiRisk">—</div>
            <div class="sub">Predicted (tower-month)</div>
          </div>
          <div class="delta" id="kpiRiskDelta">—</div>
        </div>
      </div>

      <div class="card" style="grid-column: span 4;">
        <h3>Capacity signal: TLI</h3>
        <div class="kpi">
          <div>
            <div class="value" id="kpiTli">—</div>
            <div class="sub">Latest observed</div>
          </div>
          <div class="delta" id="kpiTliDelta">—</div>
        </div>
      </div>

      <!-- KPI callouts (Dec-2025 narrative) -->
      <div class="card" style="grid-column: span 12;">
        <h3>Latest month narrative (Dec-2025)</h3>
        <div class="calloutsInline">
          <div class="calloutBadge">Backlog burn-down started</div>
          <div class="calloutBadge">IAM remediation underway</div>
          <div class="calloutBadge">Platform stabilization sprint</div>
        </div>
      </div>

      <div class="card" style="grid-column: span 7;">
        <h3>CNPS score trend (tower)</h3>
        <div id="cnpsChart" class="chart"></div>
      </div>

      <div class="card" style="grid-column: span 5;">
        <h3>Detractor risk trend (tower)</h3>
        <div id="riskChart" class="chart"></div>
      </div>

      <div class="card" style="grid-column: span 12;">
        <h3>Tower Load Index (observed + forecast)</h3>
        <div id="tliChart" class="chartTall"></div>
      </div>
    </div>

    <div class="footer">
      <div class="badge"><span class="miniDot warn"></span>Disclaimer</div>
      <div style="margin-top:8px">
        The ML models are trained locally and exported as aggregates for visualization. This GitHub Page is for demonstration/portfolio purposes only and does not represent a production system.
      </div>
    </div>
  </section>

  <!-- OPERATIONS -->
  <section id="operations" class="section">
    <div class="grid">
      <div class="card" style="grid-column: span 12;">
        <h3>Operational levers (what teams can control)</h3>
        <div class="split">
          <div>
            <p style="margin:0;color:var(--muted);line-height:1.6;font-size:13px">
              This view focuses on levers that move the North Star: reducing long-open work, balancing load across towers, and preventing spikes before they impact experience.
            </p>
            <div style="margin-top:12px" class="badge"><span class="miniDot good"></span>Use case: capacity planning + priority triage</div>
          </div>
          <div>
            <p style="margin:0;color:var(--muted);line-height:1.6;font-size:13px">
              Interpretable KPIs are exposed alongside forecasts to support governance: “what changed, why it changed, what to do next”.
            </p>
            <div style="margin-top:12px" class="badge"><span class="miniDot neutral"></span>Evidence-driven operations</div>
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: span 6;">
        <h3>Tickets vs TLI (tower-month)</h3>
        <div id="ticketsVsTli" class="chart"></div>
      </div>

      <div class="card" style="grid-column: span 6;">
        <h3>Aging signal proxy (p90 days open bucketed)</h3>
        <div id="agingChart" class="chart"></div>
      </div>

      <div class="card" style="grid-column: span 12;">
        <h3>Top towers by detractor risk (latest month)</h3>
        <div id="topTowersTable"></div>
      </div>
    </div>
  </section>

  <!-- AI WORKFLOW -->
  <section id="ai" class="section">
    <div class="grid">
      <div class="card" style="grid-column: span 12;">
        <h3>End-to-end AI workflow (what runs locally)</h3>
        <p style="margin:0;color:var(--muted);line-height:1.65;font-size:13px">
          1) Sanitize raw tickets → 2) Engineer tower-month features → 3) Compute Tower Load Index (TLI) →
          4) Forecast TLI (capacity risk) → 5) Predict detractor risk (experience risk) → 6) Publish a demo dashboard (this page).
        </p>
        <div class="pillrow" style="margin-top:12px">
          <div class="pill"><span class="dot a"></span>Forecast model: gradient-boosted regression (fast, strong tabular baseline)</div>
          <div class="pill"><span class="dot b"></span>Risk model: gradient-boosted classification (probability output)</div>
        </div>
      </div>

      <div class="card" style="grid-column: span 6;">
        <h3>Why gradient boosting?</h3>
        <p style="margin:0;color:var(--muted);line-height:1.65;font-size:13px">
          For tabular operational data with mixed categorical + numeric signals, gradient boosting typically delivers strong accuracy with minimal feature scaling, supports non-linear interactions, and can produce feature importance for governance narratives.
        </p>
      </div>

      <div class="card" style="grid-column: span 6;">
        <h3>How it improves the North Star</h3>
        <p style="margin:0;color:var(--muted);line-height:1.65;font-size:13px">
          Forecasting TLI identifies upcoming capacity hotspots; the risk model estimates detractor probability. Teams can intervene (rebalance work, reduce aging backlog), lowering predicted detractor risk and improving CNPS over time.
        </p>
      </div>

      <div class="card" style="grid-column: span 12;">
        <h3>Scenario impact (simulated)</h3>
        <div id="scenarioChart" class="chartTall"></div>
        <p style="margin:10px 4px 0;color:var(--muted2);font-size:12px;line-height:1.5">
          Scenario is a portfolio-style simulation using exported aggregates. In a production system, the scenario would be driven by real SLA actions and re-scored continuously.
        </p>
      </div>
    </div>
  </section>

  <!-- ABOUT -->
  <section id="about" class="section">
    <div class="grid">
      <div class="card" style="grid-column: span 12;">
        <h3>About</h3>
        <div class="split">
          <div>
            <h2 style="margin:0;font-size:18px;font-weight:900">Balaji Gopinath, PMP, CSM</h2>
            <p style="margin:10px 0 0;color:var(--muted);line-height:1.65;font-size:13px">
              Focused on implementing AI in program governance and operational excellence—turning operational telemetry (tickets, SLA signals, capacity metrics)
              into decision systems that improve reliability, stakeholder experience, and execution predictability.
            </p>
            <p style="margin:10px 0 0;color:var(--muted);line-height:1.65;font-size:13px">
              Portfolio: <a href="https://www.balajigopinath.work" target="_blank" rel="noreferrer">https://www.balajigopinath.work</a>
            </p>
            <div class="pillrow" style="margin-top:14px">
              <div class="pill"><span class="dot a"></span>Program governance</div>
              <div class="pill"><span class="dot b"></span>Operational excellence</div>
              <div class="pill"><span class="dot c"></span>AI-driven decision systems</div>
            </div>
          </div>

          <div>
            <div class="callout">
              <h3>What this demo communicates</h3>
              <p>
                AI isn’t just “prediction”—it’s a governance loop: measure → forecast → prioritize → intervene → learn. This page demonstrates how to present that loop as a stakeholder-ready product artifact.
              </p>
              <p style="margin-top:10px">
                To tailor this About section precisely to your portfolio tone and content, paste the text from your website’s About/Projects sections (the page couldn’t be fetched automatically in this environment).
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
  // ---------- Config (static assets) ----------
  const PATHS = {
    towerKpis: "outputs/tower_month_kpis.csv",
    tliForecast: "outputs/tli_forecast.csv",
    riskByTowerMonth: "outputs/cnps_risk_by_tower_month.csv"
  };

  // ---------- Utilities ----------
  function loadCSV(path){
    return new Promise((resolve, reject) => {
      Papa.parse(path, {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: (res) => resolve(res.data),
        error: (err) => reject(err)
      });
    });
  }

  function fmt(n, digits=0){
    if(n === null || n === undefined || Number.isNaN(n)) return "—";
    return Number(n).toLocaleString(undefined, {maximumFractionDigits: digits});
  }

  function pct(n, digits=1){
    if(n === null || n === undefined || Number.isNaN(n)) return "—";
    return (Number(n)*100).toLocaleString(undefined, {maximumFractionDigits: digits}) + "%";
  }

  function deltaBadge(el, value){
    el.classList.remove("good","bad","warn");
    if(value === null || value === undefined || Number.isNaN(value)){
      el.textContent = "—"; return;
    }
    const sign = value >= 0 ? "+" : "";
    el.textContent = `${sign}${fmt(value,1)}`;
    if(value >= 2) el.classList.add("good");
    else if(value <= -2) el.classList.add("bad");
    else el.classList.add("warn");
  }

  function setActiveTab(name){
    document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab===name));
    document.querySelectorAll(".section").forEach(s => s.classList.toggle("active", s.id===name));
    // force charts to resize after a tab change (avoid clipped renders)
    setTimeout(()=> safeResizeAllPlots(), 120);
    window.scrollTo({top:0, behavior:"smooth"});
  }

  // ---------- Global state ----------
  const state = {
    tower: null,
    scenarioReductionPct: 0,
    kpis: [],
    forecast: [],
    risk: []
  };

  // ---------- Embedded data (hand-authored arrays mapped to rows) ----------
  // Months (observed): Jan-2024 .. Dec-2025 (24 months)
  const MONTHS_OBS = [
    "2024-01-01","2024-02-01","2024-03-01","2024-04-01","2024-05-01","2024-06-01",
    "2024-07-01","2024-08-01","2024-09-01","2024-10-01","2024-11-01","2024-12-01",
    "2025-01-01","2025-02-01","2025-03-01","2025-04-01","2025-05-01","2025-06-01",
    "2025-07-01","2025-08-01","2025-09-01","2025-10-01","2025-11-01","2025-12-01"
  ];
  // Forecast: Jan-2026 .. Jun-2026 (6 months)
  const MONTHS_FC = ["2026-01-01","2026-02-01","2026-03-01","2026-04-01","2026-05-01","2026-06-01"];

  // Towers (exact names)
  const TOWERS = [
    "Service Desk",
    "End User Computing",
    "Network Operations",
    "Security Operations",
    "Identity & Access Management",
    "Enterprise Applications",
    "Cloud & Platform",
    "Database Services"
  ];

  // Hand-authored per-tower vectors (each vector length 24 for observed KPI/risk and 6 for forecast)
  // Values chosen to meet the realism requirements and event spikes described in the brief.

  // --- Service Desk ---
  const SD_tickets = [2200,2100,2600,2400,2300,2500,2400,2350,2600,2700,2400,2300,2250,2150,2350,2300,2250,2200,2100,2050,2150,2300,2400,2250];
  const SD_tli =     [90,  88, 100, 95,  92,  98,  96,  94,  102, 110, 98,  93,  92,  90, 95,  94,  92,  90,  88,  86,  90,  96,  100, 94];
  const SD_cnps =    [62.5,63.0,60.0,61.0,60.5,59.0,60.0,61.0,59.5,58.0,60.5,61.5,62.0,62.2,61.8,61.5,62.0,62.5,63.0,63.5,63.8,63.0,62.0,62.8];
  const SD_p90 =     [18,  17, 20, 19,  21,  22,  20,  19,  23,  24,  22,  25,  26,  24,  23,  22,  20,  18,  17,  16,  15,  15,  16,  14];
  const SD_risk =    [0.18,0.17,0.21,0.20,0.22,0.24,0.22,0.21,0.25,0.27,0.24,0.28,0.30,0.27,0.26,0.25,0.23,0.21,0.19,0.18,0.16,0.16,0.17,0.15];
  const SD_fc_tli =  [92,90,89,88,87,86];

  // --- End User Computing ---
  const EUC_tickets = [1500,1600,1800,1700,2200,2600,2400,2100,2300,2050,1850,1700,1650,1600,1700,1650,1600,1580,1550,1520,1500,1480,1490,1470];
  const EUC_tli =     [85, 86, 95, 92, 120,130,125,110,118,105,98,90,88,86,89,87,85,84,83,81,80,79,80,78];
  const EUC_cnps =    [55.0,54.5,53.0,54.0,51.0,49.5,50.5,52.0,50.0,51.5,53.5,54.5,55.0,55.2,55.0,55.4,55.6,55.8,56.0,56.5,57.0,57.2,56.8,57.0];
  const EUC_p90 =     [20,21,25,22,28,30,28,24,26,24,22,21,20,19,18,17,16,15,14,13,12,12,13,11];
  const EUC_risk =    [0.20,0.21,0.26,0.24,0.30,0.34,0.32,0.28,0.31,0.28,0.25,0.23,0.22,0.21,0.20,0.19,0.18,0.17,0.16,0.15,0.14,0.14,0.15,0.13];
  const EUC_fc_tli =  [82,80,79,78,77,76];

  // --- Network Operations (outage in May/Jun 2024) ---
  const NET_tickets = [700,800,1200,900,1800,2000,1400,1000,1500,1200,900,850,800,780,860,840,820,800,780,760,1400,1250,1100,950];
  const NET_tli =     [70, 75, 95, 80, 140,150,110,90,130,100,85,80,78,76,82,80,78,76,74,72,120,110,100,90];
  const NET_cnps =    [68.0,67.5,64.0,66.0,57.0,55.5,60.0,63.0,58.0,62.0,64.5,65.0,66.0,66.5,66.8,67.0,67.2,67.5,68.0,68.5,60.0,62.0,64.0,65.0];
  const NET_p90 =     [10,11,18,12,28,30,22,14,26,18,12,10,9,8,9,9,8,7,6,6,20,16,14,12];
  const NET_risk =    [0.12,0.13,0.22,0.15,0.40,0.45,0.30,0.18,0.34,0.21,0.15,0.13,0.11,0.10,0.12,0.11,0.10,0.09,0.09,0.08,0.33,0.29,0.25,0.20];
  const NET_fc_tli =  [88,85,90,86,84,82];

  // --- Security Operations (audit Oct/Nov 2024) ---
  const SEC_tickets = [600,650,700,680,700,720,710,700,740,1100,1300,1150,1080,1050,1020,1000,980,960,940,920,900,880,870,860];
  const SEC_tli =     [72,73,76,74,76,78,77,76,80,110,130,115,108,105,102,100,98,96,94,92,90,88,86,84];
  const SEC_cnps =    [66.0,65.5,65.0,65.8,65.2,64.8,65.0,65.4,64.0,55.0,50.0,52.0,54.0,55.0,56.0,56.8,57.2,57.8,58.0,58.4,58.6,59.0,59.4,60.0];
  const SEC_p90 =     [8,9,10,9,10,11,10,9,10,18,25,22,20,18,16,15,14,13,12,11,10,9,9,8];
  const SEC_risk =    [0.10,0.11,0.12,0.11,0.12,0.14,0.13,0.12,0.13,0.28,0.40,0.34,0.30,0.28,0.26,0.24,0.22,0.20,0.18,0.17,0.16,0.15,0.14,0.13];
  const SEC_fc_tli =  [82,80,78,76,75,74];

  // --- Identity & Access Management (audit + IAM recert in Q4-2024; elevated in Q4-2025) ---
  const IAM_tickets = [500,520,540,560,600,650,620,610,630,700,900,850,820,800,780,760,850,900,920,940,960,980,1050,1120];
  const IAM_tli =     [68,69,70,72,75,80,78,76,78,82,100,95,92,90,88,86,92,96,98,100,102,105,110,115];
  const IAM_cnps =    [64.0,63.8,63.5,63.2,62.8,62.0,62.5,62.8,62.0,60.5,55.0,56.0,56.5,57.0,57.5,58.0,56.5,55.0,54.5,54.0,53.8,53.5,53.2,53.8];
  const IAM_p90 =     [12,12,14,13,15,18,16,15,16,18,25,24,23,22,20,19,24,26,28,30,32,34,36,38];
  const IAM_risk =    [0.14,0.14,0.15,0.15,0.18,0.22,0.20,0.19,0.20,0.24,0.36,0.34,0.33,0.32,0.30,0.29,0.35,0.38,0.40,0.42,0.44,0.46,0.50,0.52];
  const IAM_fc_tli =  [112,108,110,106,103,100];

  // --- Enterprise Applications (major rollout in Q4-2025) ---
  const EA_tickets = [520,540,560,580,600,620,640,660,680,740,760,760,780,800,820,840,860,880,900,950,1200,1400,1300,1250,1150];
  const EA_tli =     [70,71,73,74,76,78,80,82,84,90,95,94,95,96,98,100,102,104,106,110,130,140,135,125];
  const EA_cnps =    [63.0,62.8,62.5,62.2,62.0,61.8,61.5,61.0,60.8,60.0,59.5,60.0,60.2,60.5,60.8,61.0,61.4,61.6,61.8,61.0,55.0,52.0,54.0,56.0];
  const EA_p90 =     [10,10,11,11,12,12,13,13,14,16,18,17,17,16,15,14,13,12,12,11,20,24,22,18];
  const EA_risk =    [0.13,0.13,0.14,0.14,0.15,0.16,0.16,0.16,0.17,0.18,0.20,0.19,0.19,0.18,0.17,0.16,0.16,0.16,0.16,0.17,0.30,0.40,0.36,0.30];
  const EA_fc_tli =  [122,118,115,110,105,100];

  // --- Cloud & Platform (sustained high during Q2-2025 + Q4-2025 rollout) ---
  const CP_tickets = [800,820,850,880,900,980,960,940,980,1100,1300,1450,1500,1480,1460,1500,1550,1600,1580,1560,1620,1700,1900,1800,1650];
  const CP_tli =     [95,96,100,104,110,120,118,116,122,140,150,155,160,158,156,160,165,170,168,166,170,175,190,185];
  const CP_cnps =    [58.0,57.8,57.5,57.0,56.8,55.5,56.0,56.5,56.0,54.0,52.0,51.0,50.5,50.8,51.5,52.0,52.8,53.5,54.0,54.6,53.8,53.5,52.0,52.5];
  const CP_p90 =     [22,21,24,23,25,28,26,24,25,28,30,35,36,34,32,30,28,26,25,24,26,28,30,26];
  const CP_risk =    [0.20,0.20,0.22,0.21,0.24,0.30,0.29,0.28,0.30,0.34,0.38,0.42,0.44,0.42,0.40,0.39,0.40,0.42,0.41,0.40,0.42,0.44,0.50,0.48];
  const CP_fc_tli =  [186,180,175,170,165,160];

  // --- Database Services (consistently lower risk) ---
  const DB_tickets = [420,400,420,430,460,480,470,450,500,520,540,560,580,560,550,540,530,520,510,500,520,540,560,540];
  const DB_tli =     [65,64,65,66,68,70,69,68,72,74,76,78,80,78,76,74,72,71,70,69,68,70,72,70];
  const DB_cnps =    [70.0,70.2,70.0,69.8,69.6,69.4,69.6,69.8,69.2,69.0,68.8,68.5,68.6,68.8,69.0,69.2,69.4,69.6,69.8,70.0,69.6,69.4,69.8,70.2];
  const DB_p90 =     [6,6,7,7,8,9,8,7,9,10,11,12,13,12,11,10,9,8,7,6,7,8,9,8];
  const DB_risk =    [0.08,0.08,0.09,0.09,0.10,0.11,0.10,0.09,0.11,0.12,0.13,0.14,0.15,0.14,0.13,0.12,0.11,0.10,0.10,0.09,0.10,0.11,0.12,0.11];
  const DB_fc_tli =  [71,70,69,68,67,66];

  // Build EMBEDDED_DATA mapping arrays into row objects
  const EMBEDDED_DATA = (function buildEmbedded(){
    const kpis = [];
    const risk = [];
    const forecast = [];

    // helper to push observed KPI/risk
    function pushObserved(tower, ticketsArr, tliArr, cnpsArr, p90Arr, riskArr){
      for(let i=0;i<MONTHS_OBS.length;i++){
        kpis.push({
          Tower: tower,
          month: MONTHS_OBS[i],
          tickets: Number(ticketsArr[i]),
          tli: Number(tliArr[i]),
          cnps_score: Number(cnpsArr[i]),
          p90_days_open: Number(p90Arr[i])
        });
        risk.push({
          Tower: tower,
          month: MONTHS_OBS[i],
          detractor_risk: Number(riskArr[i]),
          cnps_score: Number(cnpsArr[i]),
          tli: Number(tliArr[i])
        });
      }
    }

    function pushForecast(tower, fcArr){
      for(let i=0;i<MONTHS_FC.length;i++){
        forecast.push({
          Tower: tower,
          month: MONTHS_FC[i],
          tli_forecast: Number(fcArr[i])
        });
      }
    }

    pushObserved("Service Desk", SD_tickets, SD_tli, SD_cnps, SD_p90, SD_risk); pushForecast("Service Desk", SD_fc_tli);
    pushObserved("End User Computing", EUC_tickets, EUC_tli, EUC_cnps, EUC_p90, EUC_risk); pushForecast("End User Computing", EUC_fc_tli);
    pushObserved("Network Operations", NET_tickets, NET_tli, NET_cnps, NET_p90, NET_risk); pushForecast("Network Operations", NET_fc_tli);
    pushObserved("Security Operations", SEC_tickets, SEC_tli, SEC_cnps, SEC_p90, SEC_risk); pushForecast("Security Operations", SEC_fc_tli);
    pushObserved("Identity & Access Management", IAM_tickets, IAM_tli, IAM_cnps, IAM_p90, IAM_risk); pushForecast("Identity & Access Management", IAM_fc_tli);
    pushObserved("Enterprise Applications", EA_tickets, EA_tli, EA_cnps, EA_p90, EA_risk); pushForecast("Enterprise Applications", EA_fc_tli);
    pushObserved("Cloud & Platform", CP_tickets, CP_tli, CP_cnps, CP_p90, CP_risk); pushForecast("Cloud & Platform", CP_fc_tli);
    pushObserved("Database Services", DB_tickets, DB_tli, DB_cnps, DB_p90, DB_risk); pushForecast("Database Services", DB_fc_tli);

    return { kpis, risk, forecast };
  })();

  // ---------- Renderers (unchanged element IDs preserved) ----------
  function getTowerSlice(rows, tower){
    return rows.filter(r => String(r.Tower) === String(tower))
      .sort((a,b) => new Date(a.month) - new Date(b.month));
  }

  function latestAndPrev(rows, field){
    const d = rows.filter(r => r[field] !== null && r[field] !== undefined && !Number.isNaN(r[field]));
    if(d.length === 0) return {latest:null, prev:null};
    const latest = d[d.length-1][field];
    const prev = d.length > 1 ? d[d.length-2][field] : null;
    return {latest, prev};
  }

  function renderKPIs(tower){
    const k = getTowerSlice(state.kpis, tower);
    const r = getTowerSlice(state.risk, tower);

    const cnps = latestAndPrev(k, "cnps_score");
    const tli  = latestAndPrev(k, "tli");
    const risk = latestAndPrev(r, "detractor_risk");

    document.getElementById("kpiCnps").textContent = fmt(cnps.latest, 1);
    document.getElementById("kpiTli").textContent  = fmt(tli.latest, 0);
    document.getElementById("kpiRisk").textContent = pct(risk.latest, 1);

    const cnpsDelta = (cnps.prev==null || cnps.latest==null) ? null : (cnps.latest - cnps.prev);
    const tliDelta  = (tli.prev==null  || tli.latest==null)  ? null : (tli.latest  - tli.prev);
    const riskDelta = (risk.prev==null || risk.latest==null) ? null : ((risk.latest - risk.prev) * 100);

    deltaBadge(document.getElementById("kpiCnpsDelta"), cnpsDelta);
    deltaBadge(document.getElementById("kpiTliDelta"), tliDelta);
    deltaBadge(document.getElementById("kpiRiskDelta"), riskDelta);
  }

  function renderOverviewCharts(tower){
    const k = getTowerSlice(state.kpis, tower);
    const r = getTowerSlice(state.risk, tower);
    const f = getTowerSlice(state.forecast, tower);

    const x = k.map(d => d.month);

    Plotly.newPlot("cnpsChart", [{
      x, y: k.map(d => d.cnps_score),
      type:"scatter", mode:"lines+markers",
      line:{color:"#2FE3C0", width:3},
      marker:{size:7}
    }], {
      margin:{l:44,r:12,t:6,b:34},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      font:{color:"#EAF0FF", family:"Inter"},
      xaxis:{gridcolor:"rgba(255,255,255,.06)"},
      yaxis:{gridcolor:"rgba(255,255,255,.06)", title:"CNPS score"},
    }, {displayModeBar:false, responsive:true});

    Plotly.newPlot("riskChart", [{
      x: r.map(d => d.month),
      y: r.map(d => d.detractor_risk),
      type:"scatter", mode:"lines+markers",
      line:{color:"#FFB020", width:3},
      marker:{size:7}
    }], {
      margin:{l:44,r:12,t:6,b:34},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      font:{color:"#EAF0FF", family:"Inter"},
      xaxis:{gridcolor:"rgba(255,255,255,.06)"},
      yaxis:{gridcolor:"rgba(255,255,255,.06)", tickformat:".0%", title:"Detractor risk"},
    }, {displayModeBar:false, responsive:true});

    // TLI observed + forecast overlay
    const observed = {
      x: k.map(d=>d.month),
      y: k.map(d=>d.tli),
      type:"scatter",
      mode:"lines+markers",
      name:"Observed",
      line:{color:"#7C5CFF", width:3},
      marker:{size:7}
    };
    const forecast = {
      x: f.map(d=>d.month),
      y: f.map(d=>d.tli_forecast),
      type:"scatter",
      mode:"lines+markers",
      name:"Forecast",
      line:{color:"#3AB8FF", width:3, dash:"dot"},
      marker:{size:7}
    };

    Plotly.newPlot("tliChart", [observed, forecast], {
      margin:{l:52,r:12,t:6,b:34},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      font:{color:"#EAF0FF", family:"Inter"},
      xaxis:{gridcolor:"rgba(255,255,255,.06)"},
      yaxis:{gridcolor:"rgba(255,255,255,.06)", title:"Tower Load Index (TLI)"},
      legend:{orientation:"h", x:0, y:1.12}
    }, {displayModeBar:false, responsive:true});
  }

  function renderOperations(tower){
    const k = getTowerSlice(state.kpis, tower);

    Plotly.newPlot("ticketsVsTli", [{
      x: k.map(d=>d.tickets),
      y: k.map(d=>d.tli),
      text: k.map(d=>d.month),
      type:"scatter",
      mode:"markers",
      marker:{size:10, color:"#7C5CFF", opacity:.85},
      hovertemplate:"Month=%{text}<br>Tickets=%{x}<br>TLI=%{y}<extra></extra>"
    }], {
      margin:{l:48,r:12,t:6,b:40},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      font:{color:"#EAF0FF", family:"Inter"},
      xaxis:{gridcolor:"rgba(255,255,255,.06)", title:"Tickets"},
      yaxis:{gridcolor:"rgba(255,255,255,.06)", title:"TLI"}
    }, {displayModeBar:false, responsive:true});

    Plotly.newPlot("agingChart", [{
      x: k.map(d=>d.month),
      y: k.map(d=>d.p90_days_open),
      type:"bar",
      marker:{color:"#FF4D6D", opacity:.85},
      hovertemplate:"Month=%{x}<br>p90 days open=%{y}<extra></extra>"
    }], {
      margin:{l:54,r:12,t:6,b:40},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      font:{color:"#EAF0FF", family:"Inter"},
      xaxis:{gridcolor:"rgba(255,255,255,.06)"},
      yaxis:{gridcolor:"rgba(255,255,255,.06)", title:"p90 Days Open"}
    }, {displayModeBar:false, responsive:true});

    // Top towers table by risk, latest month
    const latestMonth = state.kpis.map(d=>d.month).sort().slice(-1)[0];
    const riskLatest = state.risk.filter(d => d.month === latestMonth)
      .sort((a,b)=> (b.detractor_risk||0) - (a.detractor_risk||0))
      .slice(0, 8);

    const rows = riskLatest.map((d,i) => {
      const badge = d.detractor_risk >= 0.33 ? "bad" : (d.detractor_risk >= 0.25 ? "warn" : "good");
      const dot = badge;
      return `
        <tr>
          <td>${i+1}</td>
          <td>${d.Tower}</td>
          <td>${latestMonth}</td>
          <td><span class="badge"><span class="miniDot ${dot}"></span>${pct(d.detractor_risk,1)}</span></td>
          <td>${fmt(d.cnps_score,1)}</td>
          <td>${fmt(d.tli,0)}</td>
        </tr>
      `;
    }).join("");

    document.getElementById("topTowersTable").innerHTML = `
      <table class="table">
        <thead>
          <tr>
            <th>#</th><th>Tower</th><th>Month</th><th>Detractor risk</th><th>CNPS score</th><th>TLI</th>
          </tr>
        </thead>
        <tbody>${rows || `<tr><td colspan="6">No data</td></tr>`}</tbody>
      </table>
    `;
  }

  function renderScenario(tower){
    // simple simulation: reducing aging backlog reduces TLI a bit and reduces detractor risk proportionally (demo narrative)
    const k = getTowerSlice(state.kpis, tower);
    const r = getTowerSlice(state.risk, tower);

    const pctRed = state.scenarioReductionPct / 100;

    // Simulated curves (not a production causal model)
    const tliSim = k.map(d => (d.tli ?? null) == null ? null : d.tli * (1 - 0.35 * pctRed));
    const riskSim = r.map(d => (d.detractor_risk ?? null) == null ? null : Math.max(0, d.detractor_risk * (1 - 0.55 * pctRed)));

    const months = k.map(d=>d.month);

    Plotly.newPlot("scenarioChart", [
      {
        x: months, y: k.map(d=>d.tli),
        type:"scatter", mode:"lines+markers", name:"TLI (observed)",
        line:{color:"#7C5CFF", width:3}, marker:{size:7}
      },
      {
        x: months, y: tliSim,
        type:"scatter", mode:"lines+markers", name:`TLI (scenario)`,
        line:{color:"#3AB8FF", width:3, dash:"dot"}, marker:{size:7}
      },
      {
        x: r.map(d=>d.month), y: r.map(d=>d.detractor_risk),
        type:"scatter", mode:"lines+markers", name:"Detractor risk (pred)",
        yaxis:"y2",
        line:{color:"#FFB020", width:3}, marker:{size:7}
      },
      {
        x: r.map(d=>d.month), y: riskSim,
        type:"scatter", mode:"lines+markers", name:"Detractor risk (scenario)",
        yaxis:"y2",
        line:{color:"#2FE3C0", width:3, dash:"dot"}, marker:{size:7}
      }
    ], {
      margin:{l:52,r:52,t:6,b:40},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      font:{color:"#EAF0FF", family:"Inter"},
      xaxis:{gridcolor:"rgba(255,255,255,.06)"},
      yaxis:{gridcolor:"rgba(255,255,255,.06)", title:"TLI"},
      yaxis2:{
        overlaying:"y", side:"right",
        gridcolor:"rgba(255,255,255,.06)",
        tickformat:".0%",
        title:"Detractor risk"
      },
      legend:{orientation:"h", x:0, y:1.12}
    }, {displayModeBar:false, responsive:true});
  }

  function renderAll(){
    const tower = state.tower;
    renderKPIs(tower);
    renderOverviewCharts(tower);
    renderOperations(tower);
    renderScenario(tower);
    // ensure charts resize correctly after render
    setTimeout(()=> safeResizeAllPlots(), 120);
  }

  // ---------- Resize helper ----------
  let _resizeTimer = null;
  function safeResizeAllPlots(){
    const ids = ["cnpsChart","riskChart","tliChart","ticketsVsTli","agingChart","scenarioChart"];
    if(_resizeTimer) clearTimeout(_resizeTimer);
    _resizeTimer = setTimeout(()=>{
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(el && window.Plotly && typeof window.Plotly.Plots !== "undefined"){
          try{ Plotly.Plots.resize(el); }catch(e){/* ignore resize errors */ }
        }
      });
    }, 50);
  }
  window.addEventListener("resize", safeResizeAllPlots);

  // ---------- CSV validation helpers ----------
  function hasColumns(rows, cols){
    if(!Array.isArray(rows) || rows.length === 0) return false;
    const keys = Object.keys(rows[0]);
    return cols.every(c => keys.includes(c));
  }

  // ---------- Boot & data source logic ----------
  async function init(){
    // tabs
    document.querySelectorAll(".tab").forEach(t=>{
      t.addEventListener("click", ()=> setActiveTab(t.dataset.tab));
    });

    // set embedded data as default source BEFORE any CSV attempt (hard constraint)
    state.kpis = EMBEDDED_DATA.kpis.slice();
    state.risk = EMBEDDED_DATA.risk.slice();
    state.forecast = EMBEDDED_DATA.forecast.slice();

    // populate tower dropdown from embedded (or later CSV) data
    function populateTowers(){
      const towers = [...new Set(state.kpis.map(d=>String(d.Tower)))].sort();
      const sel = document.getElementById("towerSelect");
      sel.innerHTML = towers.map(t=>`<option value="${t}">${t}</option>`).join("");
      if(!state.tower) state.tower = towers[0];
      sel.value = state.tower;
      sel.addEventListener("change", (e)=>{
        state.tower = e.target.value;
        renderAll();
      });
    }
    populateTowers();

    // scenario slider
    const slider = document.getElementById("scenarioSlider");
    const label = document.getElementById("scenarioLabel");
    slider.addEventListener("input", ()=>{
      state.scenarioReductionPct = Number(slider.value);
      label.textContent = `${state.scenarioReductionPct}% reduction`;
      renderScenario(state.tower);
    });

    // data source select (embedded by default)
    const dataSelect = document.getElementById("dataSourceSelect");
    const csvNoteEl = document.getElementById("csvNote");
    dataSelect.addEventListener("change", async (e)=>{
      const v = e.target.value;
      csvNoteEl.style.display = "none";
      if(v === "embedded"){
        // revert to embedded (already in state, but ensure it's used)
        state.kpis = EMBEDDED_DATA.kpis.slice();
        state.risk = EMBEDDED_DATA.risk.slice();
        state.forecast = EMBEDDED_DATA.forecast.slice();
        populateTowers();
        renderAll();
        return;
      }

      // Attempt CSV load (optional)
      try{
        const [kpisCsv, fcCsv, riskCsv] = await Promise.all([
          loadCSV(PATHS.towerKpis).catch(()=>null),
          loadCSV(PATHS.tliForecast).catch(()=>null),
          loadCSV(PATHS.riskByTowerMonth).catch(()=>null)
        ]);

        // Validate non-empty + expected columns (use field names the renderers expect)
        const kpisValid = kpisCsv && Array.isArray(kpisCsv) && kpisCsv.length > 0 && hasColumns(kpisCsv, ["Tower","month","tickets","tli","cnps_score","p90_days_open"]);
        const fcValid = fcCsv && Array.isArray(fcCsv) && fcCsv.length > 0 && hasColumns(fcCsv, ["Tower","month","tli_forecast"]);
        const riskValid = riskCsv && Array.isArray(riskCsv) && riskCsv.length > 0 && hasColumns(riskCsv, ["Tower","month","detractor_risk"]);

        if(kpisValid && fcValid && riskValid){
          // sanitize (filter rows with Tower & month) and coerce numeric fields if possible
          state.kpis = kpisCsv.filter(d=>d.Tower && d.month).map(d=>{
            return {
              Tower: String(d.Tower),
              month: String(d.month),
              tickets: Number(d.tickets),
              tli: Number(d.tli),
              cnps_score: Number(d.cnps_score),
              p90_days_open: Number(d.p90_days_open)
            };
          });
          state.forecast = fcCsv.filter(d=>d.Tower && d.month).map(d=>{
            return {
              Tower: String(d.Tower),
              month: String(d.month),
              tli_forecast: Number(d.tli_forecast)
            };
          });
          state.risk = riskCsv.filter(d=>d.Tower && d.month).map(d=>{
            return {
              Tower: String(d.Tower),
              month: String(d.month),
              detractor_risk: Number(d.detractor_risk),
              cnps_score: Number(d.cnps_score || NaN),
              tli: Number(d.tli || NaN)
            };
          });

          // repopulate towers and render
          populateTowers();
          renderAll();
          // hide any CSV note
          csvNoteEl.style.display = "none";
        } else {
          // revert to embedded silently and show note
          state.kpis = EMBEDDED_DATA.kpis.slice();
          state.risk = EMBEDDED_DATA.risk.slice();
          state.forecast = EMBEDDED_DATA.forecast.slice();
          populateTowers();
          renderAll();
          csvNoteEl.style.display = "inline-block";
        }
      } catch(err){
        // fallback to embedded; show note; no alert
        state.kpis = EMBEDDED_DATA.kpis.slice();
        state.risk = EMBEDDED_DATA.risk.slice();
        state.forecast = EMBEDDED_DATA.forecast.slice();
        populateTowers();
        renderAll();
        csvNoteEl.style.display = "inline-block";
        console.error("CSV load error:", err);
      }
    });

    // initial render (embedded data is already set)
    renderAll();
  }

  // Run init (no blocking alert on error). Any unexpected exceptions are logged.
  init().catch(err=>{
    console.error("Init error:", err);
    // fallback to embedded if anything went wrong during init
    state.kpis = EMBEDDED_DATA.kpis.slice();
    state.risk = EMBEDDED_DATA.risk.slice();
    state.forecast = EMBEDDED_DATA.forecast.slice();
    try{ renderAll(); }catch(e){console.error(e);}
  });
</script>
</body>
</html>
